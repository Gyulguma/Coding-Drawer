name: Auto-generate Wiki Page for AC/PS

on:
  push:
    branches: [ main ] # main 브랜치에 푸시될 때만 실행

jobs:
  build-wiki:
    runs-on: ubuntu-latest
    steps:
      # 1. 메인 리포지토리(Coding-Drawer)를 체크아웃합니다.
      #    (fetch-depth: 2 는 최근 2개 커밋을 비교하기 위함)
      - name: Checkout Main Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2. 이번 푸시에서 새로 추가된(A) 'README.md' 파일 목록을 찾습니다.
      #    (백준 또는 프로그래머스 폴더 안의 README.md만 해당)
      - name: Get newly added README.md files
        id: get_files
        run: |
          git config core.quotePath false
          FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep -E "^(백준|프로그래머스)/.*/README.md$" || true)
          echo "Found new files: $FILES"
          echo "files=$FILES" >> $GITHUB_OUTPUT

      # 3. 새 파일이 있을 경우에만 Wiki 리포지토리(Coding-Drawer.wiki)를 체크아웃합니다.
      - name: Checkout Wiki Repo
        if: steps.get_files.outputs.files != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki # "Gyulguma/Coding-Drawer.wiki"
          path: wiki # 'wiki' 라는 폴더에 받음
          token: ${{ secrets.GITHUB_TOKEN }} # 인증을 위한 기본 토큰

      # 4. 새 README.md 파일을 하나씩 읽어 Wiki 페이지를 생성하고 커밋합니다.
      - name: Generate and Commit to Wiki
        if: steps.get_files.outputs.files != ''
        run: |
          while IFS= read -r FILE_PATH; do
            [ -z "$FILE_PATH" ] && continue
            echo "--- Processing: $FILE_PATH ---"

            # 4-1. 기본 정보 설정
            PLATFORM=$(echo "$FILE_PATH" | cut -d'/' -f1) # "백준" or "프로그래머스"
            DIR_PATH=$(dirname "$FILE_PATH")             # "백준/Gold/1005. ACM Craft"

            # 4-2. README.md 첫 줄 읽어서 정보 파싱 (예: "[Gold III] ACM Craft - 1005")
            TITLE_LINE=$(head -n 1 "$FILE_PATH" | sed 's/^# //') # Markdown의 '# ' 제거
            
            DIFFICULTY=$(echo "$TITLE_LINE" | grep -o '\[.*\]' | head -n 1) # "[Gold III]" or "[level 2]"
            PROBLEM_NUM=$(echo "$TITLE_LINE" | grep -oE '\- [0-9]+$' | sed 's/- //') # "1005" or "118667"
            # 제목에서 난이도와 문제번호를 제외하여 순수 문제 제목만 추출
            PROBLEM_NAME=$(echo "$TITLE_LINE" | sed -e "s/^${DIFFICULTY} //" -e "s/ - ${PROBLEM_NUM}$//") # "ACM Craft"

            # 4-3. 플랫폼에 맞춰 문제 링크 생성
            PROBLEM_LINK=""
            if [ "$PLATFORM" == "백준" ]; then
              PROBLEM_LINK="https://www.acmicpc.net/problem/$PROBLEM_NUM"
            elif [ "$PLATFORM" == "프로그래머스" ]; then
              PROBLEM_LINK="https://school.programmers.co.kr/learn/courses/30/lessons/$PROBLEM_NUM"
            fi

            # 4-4. 같은 폴더에 있는 솔루션 파일(.java, .py 등) 찾기
            # (여러 언어로 풀 경우 첫 번째 파일만 선택됨)
            SOLUTION_FILE_NAME=$(find "$DIR_PATH" -maxdepth 1 \( -name "*.java" -o -name "*.py" -o -name "*.cpp" -o -name "*.js" \) -exec basename {} \; | head -n 1)
            
            # URL에 공백이 포함될 수 있으므로 %20으로 인코딩
            ENCODED_DIR_PATH=$(echo "$DIR_PATH" | sed 's/ /%20/g')
            ENCODED_FILE_NAME=$(echo "$SOLUTION_FILE_NAME" | sed 's/ /%20/g')
            SOLUTION_LINK="https://github.com/${{ github.repository }}/blob/main/${ENCODED_DIR_PATH}/${ENCODED_FILE_NAME}"

            # 4-5. Wiki 페이지 제목 및 파일 이름 설정
            WIKI_PAGE_TITLE="[$PLATFORM] $DIFFICULTY $PROBLEM_NUM. $PROBLEM_NAME"
            # Wiki 파일명은 링크로 쓰기 좋게 특수문자 제거, 공백은 하이픈(-)으로 (예: 백준-Gold-III-1005.-ACM-Craft.md)
            WIKI_FILE_NAME=$(echo "$WIKI_PAGE_TITLE" | sed -e 's/\[//g' -e 's/\]//g' -e 's/ /-/g' -e 's/\.--/./g' -e 's/:-/./g').md
            WIKI_FILE_PATH="./wiki/$WIKI_FILE_NAME"

            echo "Creating Wiki Page: $WIKI_PAGE_TITLE"
            echo "File Path: $WIKI_FILE_PATH"

            # 4-6. 템플릿을 사용하여 Wiki 페이지 파일 생성
            {
              echo "# $WIKI_PAGE_TITLE"
              echo ""
              echo "### 1. 문제 링크"
              echo "- $PROBLEM_LINK"
              echo ""
              echo "### 2. 솔루션 코드 링크"
              echo "- [GitHub에서 내 풀이 보기]($SOLUTION_LINK)"
              echo ""
              echo "### 3. 풀이 시간"
              echo "- (여기를 수정하세요)"
              echo ""
              echo "### 4. 접근 방법"
              echo "- (여기를 수정하세요)"
              echo ""
              echo "### 5. 배운 점 / 느낀 점"
              echo "- (여기를 수정하세요)"
            } > "$WIKI_FILE_PATH"
          done <<< "${{ steps.get_files.outputs.files }}"

      # 5. 생성된 Wiki 페이지들을 Wiki 리포지토리에 푸시
      - name: Push changes to Wiki
        if: steps.get_files.outputs.files != ''
        run: |
          cd wiki
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "Wiki Bot"
          git add .
          # 변경 사항이 있을 때만 커밋 (중복 실행 방지)
          if ! git diff-index --quiet HEAD; then
            git commit -m "Auto-generate wiki page(s) for new solution(s) [skip ci]"
            git push
          else
            echo "No new wiki pages to commit."
          fi
